# Chapter 5. 트랜잭션과 잠금
## 5.1 트랜잭션
### 5.1.1 MySQL에서의 트랜잭션
트랜잭션은 하나의 논리적인 작업 셋에 하나의 쿼리가 있든 두 개 이상의 쿼리가 있든 관계없이 논리적인 작업 셋 자체가 100% 적용되거나 아무거나 적용되지 않아야 함을 보장해 주는 것이다.

InnoDB에서는 트랜잭션을 지원하지만, MyISAM과 메모리 스토리지 엔진에서는 트랜잭션을 지원하지 않는다.
### 5.1.2 주의사항
트랜잭션 또한 DBMS의 커넥션과 동일하게 꼭 필요한 최소의 코드에만 적용하는 것이 좋다.

다음과 같이 사용자가 게시판에 게시물을 작성한 후 저장 버튼을 클릭하여 서버에 처리한다고 가정해본다.
```text
1) 처리 시작
    ==> 데이터베이스 커넥션 생성
    ==> 트랜잭션 시작
2) 사용자의 로그인 여부 확인
3) 사용자의 글쓰기 내용의 오류 여부 확인
4) 첨부로 업로드된 파일 확인 및 저장
5) 사용자의 입력 내용을 DBMS에 저장
6) 첨부 파일 정보를 DBMS에 저장
7) 저장된 내용 또는 기타 정보를 DBMS에서 조회
8) 게시물 등록에 대한 알림 메일 발송
9) 알림 메일 발송 이력을 DBMS에 저장
    ==> 트랜잭션 종료(commit)
    ==> 데이터베이스 커넥션 반납
10) 처리 완료
```

### 개선점
1. 실제로 DBMS에 데이터를 저장하는 작업은 5번부터 시작하기 때문에, 1번부터 4번까지의 작업은 트랜잭션에 포함시킬 필요가 없다.
2. 더 큰 위험은 8번 작업이다. 메일 전송이나 FTP 파일 전송 작업 또는 네트워크를 통해 원격 서버와 통신하는 등과 같은 작업은 어떻게 해서든 DBMS의 트랜잭션 내에서 제거하는 것이 좋다.
3. 사용자가 입력한 정보를 저장하는 5번과 6번 작업은 반드시 하나의 트랜잭션으로 묶어야 하며, 7번 작업은 단순 확인 및 조회이므로 트랜잭션에 포함할 필요는 없다.
    9번 작업도 별개의 트랜잭션으로 묶는다.

개선된 트랜잭션 처리 절차
```text
1) 처리 시작
2) 사용자의 로그인 여부 확인
3) 사용자의 글쓰기 내용의 오류 여부 확인
4) 첨부로 업로드된 파일 확인 및 저장
    ==> 데이터베이스 커넥션 생성
    ==> 트랜잭션 시작
5) 사용자의 입력 내용을 DBMS에 저장
6) 첨부 파일 정보를 DBMS에 저장
    ==> 트랜잭션 종료(commit)
7) 저장된 내용 또는 기타 정보를 DBMS에서 조회
8) 게시물 등록에 대한 알림 메일 발송
    ==> 트랜잭션 시작
9) 알림 메일 발송 이력을 DBMS에 저장
    ==> 트랜잭션 종료(commit)
    ==> 데이터베이스 커넥션 반납
10) 처리 완료
```

## 5.2 MySQL 엔진의 잠금
MySQL에서 사용되는 잠금은 크게 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 있다. 
MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향을 미치지는 않는다.
MySQL 엔진에서는 테이블 데이터 동기화를 위한 테이블 락 이외에도 테이블의 구조를 잠그는 메타데이터 락 그리고 사용자의 필요에 맞게 사용할 수 있는 네임드 락이라는 잠금 기능도 제공한다.

### 5.2.1 글로벌 락
글로벌 락은 `FLUSH TABLES WITH READ LOCK` 명령으로 획득할 수 있으며, MySQL에서 제공하는 잠금 가운데 가장 범위가 크다.
글로벌 락이 영향을 미치는 범위는 MySQL 서버 전체이며ㅡ 작업 대상 테이블이나 데이터베이스가 다르더라도 동일하게 영향을 미친다.

InnoDB에서는 글로벌 락 보다 가벼운 백업락을 제공해 준다. 백업락을 획득하면 모든 세션에서 테이블의 스키마나 사용자의 인증 관련 정보를 변경할 수는 없지만, 일반적인 테이블의 데이터 변경은 허용한다.

### 5.2.2 테이블 락
테이블 락은 개별 테이블 단위로 설정되는 잠금이며, 명시적 또는 묵시적으로 특정 테이블의 락을 획득할 수 있다.

명시적으로는 `LOCK TABLES table_name [READ | WRITE]` 명령을 사용하고, 묵시적인 테이블 락은 쿼리가 실행되는 동안 자동으로 획득됐다가 쿼리가 완료된 후 자동 해제된다.

InnoDB 테이블에도 테이블 락이 설정되지만 레코드 기반의 잠금을 제공하기 때문에 대부분의 데이터 변경(DML) 쿼리에서는 무시되고 스키마를 변경하는 쿼리(DDL)의 경우에만 영향을 미친다.

### 5.2.3 네임드 락
네임드 락은 GET_LOCK() 함수를 이용해 임의의 문자열에 대해 잠금을 설정할 수 있다.

네임드 락은 단순히 사용자가 지정한 문자열에 대해 획득하고 반납하는 잠금이기 때문에 자주 사용되지는 않는다.

배치 프로그램처럼 한꺼번에 많은 레코드를 변경하는 쿼리 작업을 수행할 때, 동일 데이터를 변경하거나 참조하는 프로그램끼리 분류해서 네임드 락을 걸고 쿼리를 실행하면 데드락을 방지할 수 있다.

### 메타데이터 락
메타데이터 락은 데이터베이스 객체의 이름이나 구조를 변경하는 경우에 획득하는 잠금이다.

메타데이터 락은 명시적으로 획득하거나 해제할 수 있는 것이 아니고 "RENAME TABLE tab_a TO tab_b"와 같이 테이블의 이름을 변경하는 경우 자동으로 획득하는 잠금이다.